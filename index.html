<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Technician Metrics Dashboard</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f4f4f4; }
    .hidden { display: none; }
    .panel { padding: 20px; background: white; margin: 20px; border-radius: 8px; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; }
    .btn { background-color: #004aad; color: white; border: none; cursor: pointer; }
    .btn:hover { background-color: #002f72; }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>Technician Metrics Dashboard</h2>
    <p>Created by Wagner Bierd</p>
    <img src="logo.png" alt="COIN Logo" style="max-width: 120px;" />
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button class="btn" onclick="login()">Login</button>
  </div>

  <div id="adminPanel" class="panel hidden">
    <h3>Admin Dashboard</h3>
    <button class="btn" onclick="showUserForm()">Add User</button>
    <button class="btn" onclick="showInventoryForm()">Add Inventory</button>
    <button class="btn" onclick="showGoalForm()">Set Validator Goals</button>
    <button class="btn" onclick="exportToExcel()">Export Excel</button>
    <button class="btn" onclick="exportToPDF()">Export PDF</button>
    <div id="adminForms"></div>
  </div>

  <div id="techPanel" class="panel hidden">
    <h3>Technician Dashboard</h3>
    <button class="btn" onclick="claimOrder()">Claim Order</button>
    <button class="btn" onclick="updateOrderStatus()">Update Order</button>
    <button class="btn" onclick="uploadEvidence()">Upload Evidence</button>
    <div id="techOrders"></div>
  </div>

  <div id="superPanel" class="panel hidden">
    <h3>Supervisor Dashboard</h3>
    <canvas id="goalChart" width="400" height="150"></canvas>
    <div id="superData"></div>
  </div>

  <script>
    const users = {
      "Wagnerb20": { password: "291179wer", role: "admin", firstLogin: true },
      "tech1": { password: "1234", role: "technician", firstLogin: true },
      "super1": { password: "5678", role: "supervisor", firstLogin: true }
    };

    function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (users[u] && users[u].password === p) {
        localStorage.setItem("currentUser", u);
        document.getElementById("loginBox").classList.add("hidden");
        showDashboard(users[u].role);
      } else {
        alert("Invalid credentials");
      }
    }

    function showDashboard(role) {
      document.getElementById("adminPanel").classList.add("hidden");
      document.getElementById("techPanel").classList.add("hidden");
      document.getElementById("superPanel").classList.add("hidden");

      if (role === "admin") document.getElementById("adminPanel").classList.remove("hidden");
      if (role === "technician") document.getElementById("techPanel").classList.remove("hidden");
      if (role === "supervisor") document.getElementById("superPanel").classList.remove("hidden");
    }
  </script>
  <script>
  function showUserForm() {
    document.getElementById("adminForms").innerHTML = `
      <h4>Add User</h4>
      <input id="newUsername" placeholder="Username" />
      <input id="newPassword" placeholder="Password" type="password" />
      <select id="newRole">
        <option value="technician">Technician</option>
        <option value="supervisor">Supervisor</option>
      </select>
      <button class="btn" onclick="addUser()">Create</button>
    `;
  }

  function addUser() {
    const user = document.getElementById("newUsername").value;
    const pass = document.getElementById("newPassword").value;
    const role = document.getElementById("newRole").value;
    if (!user || !pass) {
      alert("Please enter all user fields.");
      return;
    }
    if (users[user]) {
      alert("User already exists.");
      return;
    }
    users[user] = { password: pass, role: role, firstLogin: true };
    localStorage.setItem("users", JSON.stringify(users));
    alert("User created.");
    document.getElementById("adminForms").innerHTML = "";
  }

  function showInventoryForm() {
    document.getElementById("adminForms").innerHTML = `
      <h4>Add Inventory Item</h4>
      <input id="invName" placeholder="Item Name" />
      <input id="invQty" type="number" placeholder="Quantity" />
      <select id="invCat">
        <option value="validator">Validator Parts</option>
        <option value="cable">Cables</option>
        <option value="screen">Screens</option>
      </select>
      <button class="btn" onclick="addInventory()">Add</button>
    `;
  }

  let inventory = JSON.parse(localStorage.getItem("inventory") || "[]");

  function addInventory() {
    const name = document.getElementById("invName").value;
    const qty = parseInt(document.getElementById("invQty").value);
    const cat = document.getElementById("invCat").value;
    if (!name || isNaN(qty)) {
      alert("Invalid inventory data.");
      return;
    }
    inventory.push({ name, qty, cat });
    localStorage.setItem("inventory", JSON.stringify(inventory));
    alert("Inventory added.");
    document.getElementById("adminForms").innerHTML = "";
  }

  function showGoalForm() {
    document.getElementById("adminForms").innerHTML = `
      <h4>Set Validator Goal</h4>
      <select id="goalBrand">
        <option value="MEI">MEI</option>
        <option value="UBA">UBA</option>
        <option value="JCM">JCM</option>
      </select>
      <input id="goalModel" placeholder="Model" />
      <input id="goalQty" type="number" placeholder="Daily Minimum" />
      <button class="btn" onclick="addGoal()">Set Goal</button>
    `;
  }

  let validatorGoals = JSON.parse(localStorage.getItem("validatorGoals") || "[]");

  function addGoal() {
    const brand = document.getElementById("goalBrand").value;
    const model = document.getElementById("goalModel").value;
    const qty = parseInt(document.getElementById("goalQty").value);
    if (!brand || !model || isNaN(qty)) {
      alert("Invalid goal data.");
      return;
    }
    validatorGoals.push({ brand, model, qty });
    localStorage.setItem("validatorGoals", JSON.stringify(validatorGoals));
    alert("Goal set.");
    document.getElementById("adminForms").innerHTML = "";
  }
</script>
  <script>
  let orders = JSON.parse(localStorage.getItem("orders") || "[]");

  function claimOrder() {
    const currentUser = localStorage.getItem("currentUser");
    const newOrder = {
      id: "ORD" + (orders.length + 1),
      technician: currentUser,
      status: "in progress",
      created: new Date().toLocaleString(),
      updated: new Date().toLocaleString(),
      notes: "",
      evidence: ""
    };
    orders.push(newOrder);
    localStorage.setItem("orders", JSON.stringify(orders));
    alert("Order claimed.");
    displayTechOrders();
  }

  function updateOrderStatus() {
    const id = prompt("Enter Order ID to update:");
    const order = orders.find(o => o.id === id);
    if (!order) {
      alert("Order not found.");
      return;
    }
    const status = prompt("Set status: completed, not completed, needs parts:");
    order.status = status;
    order.updated = new Date().toLocaleString();
    order.notes = prompt("Enter any notes:");
    localStorage.setItem("orders", JSON.stringify(orders));
    alert("Order updated.");
    displayTechOrders();
  }

  function uploadEvidence() {
    const id = prompt("Enter Order ID to upload evidence:");
    const order = orders.find(o => o.id === id);
    if (!order) {
      alert("Order not found.");
      return;
    }
    const file = prompt("Simulate upload (enter image URL or description):");
    order.evidence = file;
    order.updated = new Date().toLocaleString();
    localStorage.setItem("orders", JSON.stringify(orders));
    alert("Evidence added.");
    displayTechOrders();
  }

  function displayTechOrders() {
    const currentUser = localStorage.getItem("currentUser");
    const techOrders = orders.filter(o => o.technician === currentUser);
    const container = document.getElementById("techOrders");
    container.innerHTML = "<h4>Your Orders</h4>";
    techOrders.forEach(o => {
      container.innerHTML += `
        <div style="border:1px solid #ccc; margin:10px; padding:10px;">
          <strong>ID:</strong> ${o.id} <br>
          <strong>Status:</strong> ${o.status} <br>
          <strong>Created:</strong> ${o.created} <br>
          <strong>Updated:</strong> ${o.updated} <br>
          <strong>Notes:</strong> ${o.notes || "-"} <br>
          <strong>Evidence:</strong> ${o.evidence || "-"}
        </div>
      `;
    });
  }

  // Optional: auto-load orders when technician logs in
  const current = localStorage.getItem("currentUser");
  if (users[current]?.role === "technician") {
    window.onload = () => displayTechOrders();
  }
</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function renderSupervisorPanel() {
    const goal = 2000; // Global goal
    const totalCompleted = orders.filter(o => o.status === "completed").length;

    const ctx = document.getElementById('goalChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Remaining'],
        datasets: [{
          label: 'Validator Builds',
          data: [totalCompleted, goal - totalCompleted],
          backgroundColor: ['#00cc66', '#cccccc'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });

    const superData = document.getElementById("superData");
    superData.innerHTML = "<h4>Technicians Overview</h4>";
    const userKeys = Object.keys(users);
    userKeys.forEach(user => {
      if (users[user].role === "technician") {
        const userOrders = orders.filter(o => o.technician === user);
        const completed = userOrders.filter(o => o.status === "completed").length;
        const pending = userOrders.filter(o => o.status !== "completed").length;
        superData.innerHTML += `
          <div style="margin-bottom:15px;">
            <strong>${user}</strong><br>
            Completed Orders: ${completed}<br>
            Pending Orders: ${pending}
          </div>
        `;
      }
    });

    superData.innerHTML += "<h4>Inventory Status</h4>";
    inventory.forEach(item => {
      let color = "🟢";
      if (item.qty < 5) color = "🔴";
      else if (item.qty <= 15) color = "🟡";
      superData.innerHTML += `
        <div>
          ${color} ${item.name} - ${item.qty} (${item.cat})
        </div>
      `;
    });
  }

  // Auto load for supervisors
  if (users[current]?.role === "supervisor") {
    window.onload = () => renderSupervisorPanel();
  }
</script>
  <script>
  // Auto-refresh every 10 seconds for metrics
  function updateMetrics() {
    const current = localStorage.getItem("currentUser");
    if (users[current]?.role === "technician") {
      displayTechOrders();
    } else if (users[current]?.role === "supervisor") {
      renderSupervisorPanel();
    }
  }
  setInterval(updateMetrics, 10000);

  // Fake export functions
  function exportToExcel() {
    alert("Export to Excel simulated (logic can be extended with SheetJS).");
  }

  function exportToPDF() {
    alert("Export to PDF simulated (logic can be extended with jsPDF).");
  }

  // Alert simulation
  function checkAlerts() {
    const now = new Date();
    orders.forEach(order => {
      const last = new Date(order.updated);
      const diffHours = Math.abs(now - last) / 36e5;
      if (diffHours > 24 && order.status !== "completed") {
        console.log("Alert: Technician inactive on order " + order.id);
        alert("Technician inactive on order " + order.id + " for over 24 hours.");
      }
    });
  }

  // Call alerts manually or periodically
  setInterval(checkAlerts, 60000); // Every minute

  // Logout
  function logout() {
    localStorage.removeItem("currentUser");
    location.reload();
  }

  // Session check on page load
  window.addEventListener("load", () => {
    const current = localStorage.getItem("currentUser");
    if (current && users[current]) {
      document.getElementById("loginBox").classList.add("hidden");
      showDashboard(users[current].role);
    }
  });
</script>
</body>
</html>
